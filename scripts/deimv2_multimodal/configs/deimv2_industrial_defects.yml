__include__: [
  '../../../DEIMv2/configs/dataset/coco_detection.yml',
  '../../../DEIMv2/configs/runtime.yml',
  '../../../DEIMv2/configs/base/dataloader.yml',
  '../../../DEIMv2/configs/base/optimizer.yml',
  '../../../DEIMv2/configs/base/deimv2.yml',
]

# ==============================================================================
# CONFIGURACIÓN OPTIMIZADA Y ESTABLE
# ==============================================================================

output_dir: ./scripts/deimv2_multimodal/outputs/deimv2_industrial_run_stable

# ==============================================================================
# DATASET CONFIGURATION
# ==============================================================================
task: detection
num_classes: 6
remap_mscoco_category: False

train_dataloader:
  type: DataLoader
  total_batch_size: 2
  dataset:
    type: CocoDetection
    img_folder: /home/carlos/Escritorio/Proyectos_Personales/TFG_25-26/TFG-ViT/ViT/ViT-Industrial-Defects/curated_dataset_splitted_20251101_provisional_1st_version/train/images
    ann_file: /home/carlos/Escritorio/Proyectos_Personales/TFG_25-26/TFG-ViT/ViT/ViT-Industrial-Defects/curated_dataset_splitted_20251101_provisional_1st_version/train/train.json
    return_masks: False
    transforms:
      type: Compose
      ops:
        # AUGMENTATIONS MÁS SUAVES PARA ESTABILIDAD
        - {type: RandomPhotometricDistort, p: 0.3}  # ← Reducir de 0.5
        - {type: RandomZoomOut, fill: 0}
        - {type: RandomIoUCrop, p: 0.5}  # ← Reducir de 0.8
        - {type: SanitizeBoundingBoxes, min_size: 1}
        - {type: RandomHorizontalFlip}
        - {type: Resize, size: [640, 640]}
        - {type: SanitizeBoundingBoxes, min_size: 1}
        - {type: ConvertPILImage, dtype: 'float32', scale: True}
        - {type: Normalize, mean: [0.485, 0.456, 0.406], std: [0.229, 0.224, 0.225]}
        - {type: ConvertBoxes, fmt: 'cxcywh', normalize: True}
      policy:
        epoch: [0, 70, 90]  # ← Sin Mosaic pesado, flat más largo
  shuffle: True
  num_workers: 4
  drop_last: True
  collate_fn:
    type: BatchImageCollateFunction
    base_size: 640
    mixup_prob: 0.15  # ← Reducir de 0.5 (menos agresivo)
    ema_restart_decay: 0.9999
    base_size_repeat: 20
    mixup_epochs: [0, 70]  # ← Solo Mixup ligero
    stop_epoch: 90
    copyblend_epochs: [0, 0]  # ← DESACTIVAR CopyBlend (causa inestabilidad)

val_dataloader:
  type: DataLoader
  dataset:
    type: CocoDetection
    img_folder: /home/carlos/Escritorio/Proyectos_Personales/TFG_25-26/TFG-ViT/ViT/ViT-Industrial-Defects/curated_dataset_splitted_20251101_provisional_1st_version/val/images
    ann_file: /home/carlos/Escritorio/Proyectos_Personales/TFG_25-26/TFG-ViT/ViT/ViT-Industrial-Defects/curated_dataset_splitted_20251101_provisional_1st_version/val/val.json
    return_masks: False
    transforms:
      type: Compose
      ops:
        - {type: Resize, size: [640, 640]}
        - {type: ConvertPILImage, dtype: 'float32', scale: True}
        - {type: Normalize, mean: [0.485, 0.456, 0.406], std: [0.229, 0.224, 0.225]}
  shuffle: False
  num_workers: 4
  drop_last: False
  collate_fn:
    type: BatchImageCollateFunction

# ==============================================================================
# MODEL CONFIGURATION
# ==============================================================================
DEIM:
  backbone: DINOv3STAs

DINOv3STAs:
  name: vit_tiny_plus
  embed_dim: 256
  weights_path: /home/carlos/Escritorio/Proyectos_Personales/TFG_25-26/TFG-ViT/ViT/ViT-Industrial-Defects/models/backbones_DEIMv2/vittplus_distill.pt
  interaction_indexes: [3, 7, 11]
  num_heads: 4
  finetune: True
  conv_inplane: 32
  hidden_dim: 256

HybridEncoder:
  in_channels: [256, 256, 256]
  hidden_dim: 256
  dim_feedforward: 1024
  depth_mult: 0.67
  expansion: 0.34

DEIMTransformer:
  feat_channels: [256, 256, 256]
  hidden_dim: 256
  dim_feedforward: 1024
  num_layers: 4
  eval_idx: -1

# ==============================================================================
# TRAINING CONFIGURATION - BALANCE ESTABILIDAD/RENDIMIENTO
# ==============================================================================
epoches: 100
flat_epoch: 70  # ← Más largo para aprendizaje estable
no_aug_epoch: 10

lrsheduler: flatcosine
lr_gamma: 0.5
warmup_iter: 2000  # ← UN SOLO warmup_iter (sin duplicado)

# ==============================================================================
# OPTIMIZER - LR MODERADO PERO SEGURO
# ==============================================================================
optimizer:
  type: AdamW
  params: 
    -
      params: '^(?=.*.dinov3)(?!.*(?:norm|bn|bias)).*$'  
      lr: 0.00004  # ← Un poco menos que 0.00005 (más estable)
    -
      params: '^(?=.*.dinov3)(?=.*(?:norm|bn|bias)).*$'    
      lr: 0.00004
      weight_decay: 0.
    - 
      params: '^(?=.*(?:sta|encoder|decoder))(?=.*(?:norm|bn|bias)).*$'
      weight_decay: 0.

  lr: 0.0004  # ← Reducir ligeramente (de 0.0005 a 0.0004)
  betas: [0.9, 0.999]
  weight_decay: 0.0001

# ==============================================================================
# CRITERION - GRADIENT CLIPPING PARA ESTABILIDAD
# ==============================================================================
DEIMCriterion:
  matcher:
    change_matcher: True
    iou_order_alpha: 4.0
    matcher_change_epoch: 80  # ← Cambiar más tarde (80% de 100-10)

# IMPORTANTE: Añadir gradient clipping
clip_max_norm: 0.1  # ← Previene gradientes explosivos

# ==============================================================================
# HARDWARE OPTIMIZATIONS
# ==============================================================================
use_amp: True
checkpoint_freq: 5
eval_spatial_size: [640, 640]